<!doctype html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Truncation</title>
  <script src="dmxAppConnect/dmxAppConnect.js"></script>
  <script src="js/jquery-3.3.1.slim.min.js"></script>
  <script type="text/javascript" src="https://static.sketchfab.com/api/sketchfab-viewer-1.5.1.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css">
  <link href="css/jquery.slider.css" rel="stylesheet">
  <script src="js/jquery.slider.js"></script>
  <script src="dmxAppConnect/dmxBootstrap4Navigation/dmxBootstrap4Navigation.js" defer=""></script>
  <script src="dmxAppConnect/dmxBootstrap4Collapse/dmxBootstrap4Collapse.js" defer=""></script>
</head>

<body is="dmx-app" id="index">
  <div class="container wappler-block">
    <div class="row">
      <div class="col-12 col-xl col-lg col-md-12 col-sm-12 col-xl-9">
        <div class="ratio-square">
          <!-- left column: Sketchfab viewer -->
          <iframe class="ratio-inner" id="api-frame" allow="autoplay; fullscreen; vr" allowvr="" allowfullscreen=""
            mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>
        </div>
      </div>
      <div class="col-12 align-self-xl-end align-self-md-start align-self-lg-end col-lg-3 col-md-12 col-sm-12 col-xl-3">
        <div>
          <div class="container text-sm-left">
            <ul class="nav nav-tabs" id="myTab" role="tablist" style="display: none;">
              <li class="nav-item">
                <a class="nav-link active" id="home-tab" data-toggle="tab" href="#welcome" role="tab"
                  aria-controls="welcome" aria-selected="true">Welcome</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="harmonics-tab" data-toggle="tab" href="#harmonics" role="tab"
                  aria-controls="harmonics" aria-selected="false">Spherical Harmonics</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="profile-tab" data-toggle="tab" href="#truncation" role="tab"
                  aria-controls="truncation" aria-selected="false">Truncation</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="contact-tab" data-toggle="tab" href="#congrats" role="tab"
                  aria-controls="congrats" aria-selected="false">Well done!</a>
              </li>
            </ul>
            <div class="tab-content" id="myTabContent">
              <div class="tab-pane fade show active" id="welcome" role="tabpanel" aria-labelledby="welcome-tab">
                <h2 class="mt-3">Welcome!</h2>
                <!-- mobile contents -->
                <p class="d-lg-none text-lg-left">This is a short interactive training about the spectral transform
                  method. Throughout the entire course you will see above an interactive globe. You can always rotate it
                  and zoom in and out. Many of the exercises will allow you to display data on this interactive globe.
                  Please familiarise yourself with rotating and zooming.</p>
                <!-- desktop contents -->
                <p class="d-none d-lg-block text-lg-left">This is a short interactive training about the spectral
                  transform method. Throughout the entire course you will see an interactive globe on the left side. You
                  can always rotate it and zoom in and out. Many of the exercises will allow you to display data on this
                  interactive globe. Please familiarise yourself with rotating and zooming.</p>
                <button class="nexttab btn text-sm-center btn-space" style="background-color:#bbe8e8">Start</button>
              </div>
              <div class="tab-pane fade" id="harmonics" role="tabpanel" aria-labelledby="harmonics-tab">
                <h3 class="mt-3 d-none d-lg-block text-lg-left">Sliders</h3>
                <input id="zonalSlider">
                <input id="totalSlider">
                <h2 class="mt-3">Spherical Harmonics</h2>
                <p>This is a test of the rotating earth visualisation made with Sketchfab. The texture of the earth
                  should change when you press the buttons below! Let's try it!</p>
                <button class="prevtab btn btn-space" style="background-color:#fff2a0">Prev</button>
                <button class="nexttab btn text-sm-center btn-space" style="background-color:#bbe8e8">Next</button>
              </div>
              <div class="tab-pane fade" id="truncation" role="tabpanel" aria-labelledby="truncation-tab">
                <h3 class="mt-3 d-none d-lg-block text-lg-left">Slider</h3>
                <input id="trcSlider">
                <h2 class="mt-3">Truncation</h2>
                <p>The truncation is the highest zonal or total wavenumber that we use. To demonstrate the impact of
                  truncation on a familiar field the globe shows now the orography (height above sea level). This
                  orography was obtained from the spectral field used operationally in IFS. The slider below allows you
                  to change the truncation of this spectral field. Which truncation is necessary to recognise the your
                  home continent?</p>

                <button class="prevtab btn btn-space" style="background-color:#fff2a0">Prev</button>
                <button class="nexttab btn text-sm-center btn-space" style="background-color:#bbe8e8">Next</button>
              </div>
              <div class="tab-pane fade" id="congrats" role="tabpanel" aria-labelledby="congrats-tab">
                <h2 class="mt-3">Well done!</h2>
                <p>Congratulations! You finished these exercises about the spectral transform method. Feel free to go
                  back or take a look at the following recent paper which describes some of the computational challenges
                  of the spectral transform method: <a href="https://doi.org/10.5194/gmd-2018-304">The ESCAPE
                    project</a></p>
                <button class="prevtab btn btn-space" style="background-color:#fff2a0">Prev</button>
              </div>
            </div>
          </div> <!-- /.container -->

        </div>
      </div>
    </div>
  </div>
  <!-- Initialize the viewer -->
  <script type="text/javascript">
    var event = new Event('checkViewer');
    function currentPage() {
      var i, items = $('.nav-link');
      for (i = 0; i < items.length; i++) {
        if ($(items[i]).hasClass('active') == true) {
          break;
        }
      }
      return i;
    }
    /* -------------------------------------------------------------
          bootstrapTabControl
      ------------------------------------------------------------- */
    function bootstrapTabControl() {
      var i, items = $('.nav-link'), pane = $('.tab-pane');
      // next
      $('.nexttab').on('click', function () {
        i = currentPage();
        if (i < items.length - 1) {
          // for tab
          $(items[i]).removeClass('active');
          $(items[i + 1]).addClass('active');
          // for pane
          $(pane[i]).removeClass('show active');
          $(pane[i + 1]).addClass('show active');
          document.dispatchEvent(event);
        }
      });
      // Prev
      $('.prevtab').on('click', function () {
        i = currentPage();
        if (i != 0) {
          // for tab
          $(items[i]).removeClass('active');
          $(items[i - 1]).addClass('active');
          // for pane
          $(pane[i]).removeClass('show active');
          $(pane[i - 1]).addClass('show active');
          document.dispatchEvent(event);
        }
      });
    }
    bootstrapTabControl();
    function idx2trc(idx) {
      var trc = 0;
      if (idx == 0) {
        trc = 0;
      } else if (idx < 8) {
        trc = Math.pow(2, (idx - 1));
      } else if (idx == 8) {
        trc = 159;
      } else if (idx == 9) {
        trc = 399;
      } else if (idx == 10) {
        trc = 639;
      } else if (idx == 11) {
        trc = 1279;
      }
      return trc;
    }
    function pageCategory(p) {
      var c = -1;
      if (p == 0 || p == 3) {
        c = 0; // satellite image
      } else if (p == 1) {
        c = 1; // spherical harmonics
      } else if (p == 2) {
        c = 2; // orography truncation
      }
      return c;
    }
    var oldpage = -1;
    var oldtrc = -1;
    var oldm = -1;
    var oldn = -1;
    var zonalSlider = $("#zonalSlider").slider({ min: 0, max: 10, step: 1, value: 6, prefix: 'm=', thumbScale: 0.5, bubbleFontScale: 0.7, thumbColor: '#ffdd00', bubbleFormat: function (val) { return val; } });
    var totalSlider = $("#totalSlider").slider({ min: 0, max: 10, step: 1, value: 9, prefix: 'n=', thumbScale: 0.5, bubbleFontScale: 0.7, thumbColor: '#6ccccc', bubbleFormat: function (val) { return val; } });
    var trcSlider = $("#trcSlider").slider({ min: 0, max: 11, step: 1, value: 0, prefix: 'T', thumbScale: 0.5, bubbleFontScale: 0.7, thumbColor: '#6ccccc', bubbleFormat: function (val) { return idx2trc(val); }, onChangeEnd: function (val) { document.dispatchEvent(event); } });
    // Sketchfab Viewer API: Change Texture/material
    var uid = '928a81dbfcbc4944a5ecac27f820c6ca';//'fb43aced2ee14e1db1f4acb7638d352e';
    var iframe = document.getElementById('api-frame');
    var client = new window.Sketchfab(iframe);
    var myMaterials;
    var error = function () {
      console.error('Sketchfab API error');
    };
    var success = function (api) {
      api.start(function () {
        api.addEventListener('viewerready', function () {
          api.getMaterialList(function (err, materials) {
            myMaterials = materials;
            console.log(myMaterials);
          });
          api.getTextureList(function (err, textures) {
            console.log(textures);
          });
          function updateTexture() {
            console.log('started updateTexture');
            var page = currentPage();
            var trc = idx2trc(trcSlider.value);
            var m = zonalSlider.value;
            var n = totalSlider.value;
            var c = pageCategory(page);
            if (c != pageCategory(oldpage) || trc != oldtrc || m != oldm || n != oldn) {
              console.log('something has changed! page=' + page + ' trc=' + trc + ' m=' + m + ' n=' + n + ' c=' + c);
              var url = '';
              var file = '';
              var fileOcean = '';
              var changed = false;
              if (c == 0) {
                // satellite image
                url = 'https://anmrde.github.io/spectral/satellite/';
                file = 'albedoWithCloudsSmall.jpg';
                fileOcean = 'oceanMaskWithClouds.jpg';
                changed = (c != pageCategory(oldpage));
              } else if (c == 1) {
                // spherical harmonics
                url = '';
                file = '';
                fileOcean = '';
                changed = (c != pageCategory(oldpage) || m != oldm || n != oldn);
              } else if (c == 2) {
                // orography truncation
                url = 'https://anmrde.github.io/spectral/orography/greenAt60m/';
                file = 'T' + trc + '.png';
                fileOcean = 'ocean' + file;
                changed = (c != pageCategory(oldpage) || trc != oldtrc);
              }
              if (changed && file != '' && url != '') {
                console.log('got to do something! url=' + url + ' file=' + file);
                for (var i = 0; i < myMaterials.length; i++) {
                  var mat = myMaterials[i];
                  if (mat.name == 'earth') {
                    api.updateTexture(url + file, mat.channels.DiffusePBR.texture.uid, function (/*e, uid*/) { });
                    api.updateTexture(url + fileOcean, mat.channels.SpecularPBR.texture.uid, function (/*e, uid*/) { });
                    api.setMaterial(mat);
                  }
                }
              }
              oldpage = page;
              oldtrc = trc;
              oldm = m;
              oldn = n;
            }
          }

          document.addEventListener('checkViewer', function () {
            updateTexture();
          });
        });
      });
    };
    client.init(uid, {
      success: success,
      error: error,
      autostart: 1,
      preload: 1,
      ui_infos: 0,
      camera: 0,
      ui_inspector: 0
    });
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
</body>

</html>